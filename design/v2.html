<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="BiteRoulette - The lazy way to decide where to eat.">
    <title>BiteRoulette - The Lazy Edition</title>
    
    <!-- PWA Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#D64035">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- tsParticles -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;900&family=Space+Grotesk:wght@700&family=Luckiest+Guy&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fun-red': '#D64035',      
                        'fun-cream': '#FAF8F5',    
                        'fun-dark': '#2C2A32',     
                        'fun-yellow': '#FFD166',   
                        'fun-green': '#06D6A0',    
                        'fun-blue': '#118AB2',     
                        'fun-cyan': '#4CC9F0', /* New Pop Color */
                    },
                    fontFamily: {
                        'sans': ['DM Sans', 'sans-serif'],
                        'display': ['Space Grotesk', 'sans-serif'],
                        'pop': ['Luckiest Guy', 'cursive'],
                    },
                    boxShadow: {
                        'hard': '4px 4px 0px 0px #2C2A32',
                        'hard-hover': '2px 2px 0px 0px #2C2A32',
                        'hard-white': '4px 4px 0px 0px #FAF8F5',
                        'sheet': '0px -4px 0px 0px rgba(44,42,50,0.1)',
                    },
                    rotate: {
                        '3': '3deg',
                        '-3': '-3deg',
                        '6': '6deg',
                        '-6': '-6deg',
                        '12': '12deg',
                        '-12': '-12deg',
                    },
                    animation: {
                        'float': 'float-text 3s ease-in-out infinite',
                        'pulse-mega': 'pulse-mega 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite',
                        'shape-shift': 'shape-shift 2s infinite cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                        'spin-orbit': 'spin-orbit 1.5s linear infinite',
                        'pan-zoom': 'pan-zoom-subtle 20s ease-in-out infinite alternate',
                        'fade-in': 'fade-in 0.3s ease-out forwards',
                        'slide-up': 'slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'peek': 'peek 3s ease-in-out infinite',
                    },
                    keyframes: {
                        'float-text': {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        'pulse-mega': {
                            '0%': { transform: 'scale(0.9)', opacity: '0.7' },
                            '100%': { transform: 'scale(3)', opacity: '0' },
                        },
                        'shape-shift': {
                            '0%': { borderRadius: '0%', backgroundColor: '#FFD166', transform: 'rotate(0deg) scale(1)' },
                            '25%': { borderRadius: '50%', backgroundColor: '#D64035', transform: 'rotate(90deg) scale(0.8)' },
                            '50%': { borderRadius: '0% 50% 50% 50%', backgroundColor: '#06D6A0', transform: 'rotate(180deg) scale(1.1)' },
                            '75%': { borderRadius: '20px', backgroundColor: '#118AB2', transform: 'rotate(270deg) scale(0.9) skewX(10deg)' },
                            '100%': { borderRadius: '0%', backgroundColor: '#FFD166', transform: 'rotate(360deg) scale(1)' },
                        },
                        'spin-orbit': {
                            'from': { transform: 'rotate(0deg) translateY(-50px) rotate(0deg)' },
                            'to': { transform: 'rotate(360deg) translateY(-50px) rotate(-360deg)' },
                        },
                        'pan-zoom-subtle': {
                            '0%': { transform: 'scale(1.05) translate(0%, 0%)' },
                            '50%': { transform: 'scale(1.15) translate(-2%, -2%)' },
                            '100%': { transform: 'scale(1.05) translate(0%, 0%)' },
                        },
                        'fade-in': {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        'slide-up': {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        'peek': {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* CORE LAYOUT FIXES */
        html, body {
            height: 100%;
            height: 100dvh; 
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            background-color: #D64035;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255, 209, 102, 0.6) 0%, transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(6, 214, 160, 0.5) 0%, transparent 40%),
                conic-gradient(from 45deg at 50% 50%, rgba(232, 90, 79, 0.2) 0deg, rgba(255, 209, 102, 0.2) 120deg, rgba(232, 90, 79, 0.2) 240deg),
                linear-gradient(135deg, #D64035 0%, #A33028 100%);
            background-attachment: fixed;
            background-blend-mode: soft-light, soft-light, normal, normal;
            font-family: 'DM Sans', sans-serif;
            color: #2C2A32;
        }

        /* --- Interaction States --- */
        @media (hover: hover) {
            .hover-lift:hover { transform: translateY(-2px); }
        }
        .touch-squish:active { transform: scale(0.96) !important; }
        .touch-press:active { transform: translate(2px, 2px) !important; box-shadow: none !important; }

        *:focus-visible {
            outline: 4px solid #FFD166;
            outline-offset: 2px;
        }

        /* --- Falling Animation --- */
        @keyframes fall {
            0% { transform: translateY(-20vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.12; } 
            90% { opacity: 0.12; }
            100% { transform: translateY(120vh) rotate(360deg); opacity: 0; }
        }

        .falling-item {
            position: absolute;
            top: -20vh;
            color: #FAF8F5;
            pointer-events: none;
            z-index: 0;
            animation: fall linear infinite;
        }

        /* --- Transitions --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: transparent;
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform: translateY(100%);
            z-index: 10;
            pointer-events: none;
        }

        .screen.active {
            transform: translateY(0);
            pointer-events: auto;
        }

        .screen.prev {
            transform: translateY(-100%) scale(0.9);
            opacity: 0.5;
            pointer-events: none;
        }

        /* --- SHAPE SHIFTER LOADER --- */
        .loader-shape {
            width: 100px;
            height: 100px;
            border: 6px solid #2C2A32;
            box-shadow: 8px 8px 0px #2C2A32;
            animation: shape-shift 2s infinite cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
        }
        
        .orbit-dot {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #FAF8F5;
            border: 3px solid #2C2A32;
            border-radius: 50%;
            top: -20px;
            left: 50%;
            margin-left: -8px;
            transform-origin: 50% 70px;
            animation: spin-orbit 1.5s linear infinite;
        }

        /* --- Image Animation --- */
        .animate-photo {
            animation: pan-zoom-subtle 20s ease-in-out infinite alternate;
        }

        #rain-container {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        /* Hide scrollbar for horizontal scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Cursor change for drag scroll */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }

        /* Autocomplete List Styling */
        #autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 4px solid #2C2A32;
            border-radius: 1rem;
            margin-top: 8px;
            z-index: 50;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 4px 4px 0px 0px #2C2A32;
        }
        .suggestion-item {
            padding: 12px 16px;
            border-bottom: 2px solid #f0f0f0;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:active { background-color: #FAF8F5; }

        /* --- FIXED SLIDER STYLES --- */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 40px;
            background: transparent;
            position: relative;
            z-index: 10;
            cursor: pointer;
            margin: 0;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 32px;
            width: 32px;
            border-radius: 50%;
            background: #FFD166;
            border: 4px solid #2C2A32;
            cursor: pointer;
            margin-top: -12px; 
            box-shadow: 2px 2px 0px 0px #2C2A32;
            transition: transform 0.1s;
            position: relative;
            z-index: 20;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #FAF8F5;
            border: 2px solid #2C2A32;
            border-radius: 999px;
        }
        
        /* Bubble styles */
        .bubble-svg {
            fill: #FFD166;
            stroke: #2C2A32;
            stroke-width: 3px;
            filter: drop-shadow(2px 2px 0px #2C2A32);
        }
        .bubble-text {
            position: absolute;
            top: 50%;
            left: 55%;
            transform: translate(-50%, -55%);
            font-family: 'DM Sans', sans-serif;
            font-weight: 800;
            font-size: 0.8rem;
            color: #2C2A32;
            white-space: nowrap;
        }

        /* Peeking Sheet Styles */
        .sheet-handle {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            transform: translateY(0); 
            transition: transform 0.2s ease;
            z-index: 40;
        }
        .sheet-handle:active {
             transform: scale(0.98);
        }

        .feed-btn-container {
            position: fixed;
            bottom: 15%; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
        }

    </style>
</head>
<body>

    <!-- BACKGROUND ANIMATION CONTAINER -->
    <div id="rain-container" role="presentation" aria-hidden="true"></div>

    <!-- GET HELP BUTTON -->
    <button onclick="alert('Help is coming! Just follow the big buttons for now.')" class="fixed top-5 right-5 z-50 bg-fun-cream text-fun-dark border-[3px] border-fun-dark rounded-full p-2 shadow-hard-hover hover:scale-110 active:scale-95 transition-transform group" title="Get Help" aria-label="Get Help">
        <i data-lucide="help-circle" class="w-6 h-6 group-hover:rotate-12 transition-transform"></i>
    </button>

    <!-- SETTINGS ACTION SHEET (MODAL) -->
    <dialog id="settings-modal" class="fixed inset-0 z-[100] hidden items-end justify-center p-0 bg-fun-dark/80 backdrop-blur-sm w-full h-full border-none m-0 max-w-full max-h-full bg-transparent">
        <div class="bg-fun-cream w-full sm:max-w-md border-t-[4px] sm:border-[4px] border-fun-dark rounded-t-3xl sm:rounded-3xl p-6 pb-10 shadow-hard relative mx-auto animate-slide-up max-h-[90vh] overflow-y-auto">
            
            <!-- Drag Handle for Visual (Matched Style) -->
            <div class="w-20 h-2 bg-fun-dark/80 rounded-full mx-auto mb-6"></div>

            <div class="flex justify-between items-center mb-6">
                <h3 class="font-pop text-3xl text-fun-dark">Preferences</h3>
                <button onclick="closeSettings()" class="text-fun-dark hover:scale-110 transition-transform" aria-label="Close Settings">
                    <i data-lucide="x-circle" class="w-8 h-8 stroke-[2.5px]"></i>
                </button>
            </div>
            
            <form id="preferences-form" class="flex flex-col gap-8" onsubmit="return false;">
                <!-- Location -->
                <div class="space-y-2">
                    <label for="loc-input" class="block font-pop text-2xl text-fun-dark tracking-wide ml-1">Near where?</label>
                    <div class="relative group">
                        <div class="relative bg-white border-[3px] border-fun-dark rounded-2xl flex items-center p-2">
                            <div class="ml-2 mr-3"><i data-lucide="map-pin" class="w-6 h-6 text-fun-dark stroke-[3px]"></i></div>
                            <input type="text" id="loc-input" placeholder="City, neighborhood..." class="flex-1 min-w-0 bg-transparent font-sans font-medium text-lg text-fun-dark placeholder:text-fun-dark/40 outline-none" value="" autocomplete="off">
                            <button type="button" onclick="detectLocation()" class="ml-2 bg-fun-yellow text-fun-dark border-2 border-fun-dark px-3 py-1 rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-white transition-colors flex items-center gap-1 shadow-sm active:scale-95">
                                <i data-lucide="crosshair" class="w-3 h-3"></i>
                                Locate
                            </button>
                        </div>
                        <ul id="autocomplete-list" class="hidden" role="listbox"></ul>
                    </div>

                    <!-- Distance -->
                    <div class="flex items-center gap-3 px-1 pt-4">
                        <div class="flex-1 relative pt-2">
                            <input type="range" min="1" max="3" value="1" id="distance-range" oninput="updateDistanceLabel(this.value)" aria-label="Distance preference">
                            <div class="flex justify-between mt-1 font-bold text-[10px] text-fun-dark/60 font-sans uppercase tracking-widest" aria-hidden="true">
                                <span>Close</span><span>Far</span>
                            </div>
                        </div>
                        <div class="relative w-[90px] h-[40px] shrink-0 mt-1" aria-hidden="true">
                            <svg class="w-full h-full overflow-visible" viewBox="0 0 100 45">
                                <path class="bubble-svg" d="M15 0 H90 A10 10 0 0 1 100 10 V35 A10 10 0 0 1 90 45 H15 A10 10 0 0 1 5 35 L0 22.5 L5 10 A10 10 0 0 1 15 0 Z"/>
                            </svg>
                            <span id="distance-text" class="bubble-text">Walkable</span>
                        </div>
                    </div>
                </div>

                <!-- When? -->
                <fieldset class="space-y-3 relative border-none p-0 m-0">
                    <legend class="block font-pop text-2xl text-fun-dark tracking-wide ml-1 mb-2">When?</legend>
                    <div class="absolute right-0 top-10 bottom-0 w-8 bg-gradient-to-l from-white to-transparent pointer-events-none z-10" aria-hidden="true"></div>
                    
                    <div id="time-scroll-container" class="flex gap-3 overflow-x-auto pb-2 -mx-2 px-2 no-scrollbar cursor-grab active:cursor-grabbing select-none relative z-0 touch-pan-x" role="radiogroup">
                        <!-- Options -->
                        <label class="cursor-pointer group relative flex-none w-28 slider-option">
                            <input type="radio" name="time" value="now" class="peer sr-only" checked>
                            <div class="h-full bg-white border-[3px] border-fun-dark/20 peer-checked:border-fun-dark peer-checked:bg-fun-yellow rounded-xl p-3 flex flex-col items-center justify-center gap-1 transition-all active:scale-95">
                                <i data-lucide="clock" class="w-6 h-6 stroke-[2.5px] text-fun-dark"></i>
                                <span class="font-sans font-bold text-fun-dark uppercase tracking-tight text-center leading-none text-xs">Now</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group relative flex-none w-28 slider-option">
                            <input type="radio" name="time" value="tonight" class="peer sr-only">
                            <div class="h-full bg-white border-[3px] border-fun-dark/20 peer-checked:border-fun-dark peer-checked:bg-fun-yellow rounded-xl p-3 flex flex-col items-center justify-center gap-1 transition-all active:scale-95">
                                <i data-lucide="moon" class="w-6 h-6 stroke-[2.5px] text-fun-dark"></i>
                                <span class="font-sans font-bold text-fun-dark uppercase tracking-tight text-center leading-none text-xs">Tonight</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group relative flex-none w-28 slider-option">
                            <input type="radio" name="time" value="tomorrow" class="peer sr-only">
                            <div class="h-full bg-white border-[3px] border-fun-dark/20 peer-checked:border-fun-dark peer-checked:bg-fun-yellow rounded-xl p-3 flex flex-col items-center justify-center gap-1 transition-all active:scale-95">
                                <i data-lucide="sun" class="w-6 h-6 stroke-[2.5px] text-fun-dark"></i>
                                <span class="font-sans font-bold text-fun-dark uppercase tracking-tight text-center leading-none text-xs">Tomorrow</span>
                            </div>
                        </label>
                        <label class="cursor-pointer group relative flex-none w-28 slider-option">
                            <input type="radio" name="time" value="custom" class="peer sr-only" onclick="openDatePicker()">
                            <div class="h-full bg-white border-[3px] border-fun-dark/20 peer-checked:border-fun-dark peer-checked:bg-fun-yellow rounded-xl p-3 flex flex-col items-center justify-center gap-1 transition-all active:scale-95">
                                <i data-lucide="calendar-plus" class="w-6 h-6 stroke-[2.5px] text-fun-dark"></i>
                                <span class="font-sans font-bold text-fun-dark uppercase tracking-tight text-center leading-none text-xs">Custom</span>
                            </div>
                        </label>
                    </div>
                </fieldset>

                <button onclick="closeSettings()" class="w-full bg-fun-green border-[3px] border-fun-dark rounded-xl py-3 font-pop text-xl uppercase shadow-hard active:translate-y-1 active:shadow-none transition-all">
                    Done
                </button>
            </form>
        </div>
    </dialog>

    <!-- CUSTOM DATE PICKER MODAL (Nested) -->
    <dialog id="date-modal" class="fixed inset-0 z-[110] hidden items-center justify-center p-4 bg-fun-dark/80 backdrop-blur-sm animate-fade-in w-full h-full border-none m-0 max-w-full max-h-full bg-transparent">
        <div class="bg-fun-cream w-full max-w-sm border-[4px] border-fun-dark rounded-3xl p-6 shadow-hard relative mx-auto">
            <button onclick="closeDatePicker()" class="absolute top-4 right-4 text-fun-dark active:scale-95 transition-transform" aria-label="Close Date Picker">
                <i data-lucide="x-circle" class="w-8 h-8 stroke-[2.5px]"></i>
            </button>
            <h3 class="font-pop text-3xl text-fun-dark mb-2 text-center">Pick a Time</h3>
            <div class="bg-white border-2 border-fun-dark rounded-xl p-4 mb-6 shadow-inner">
                <input type="datetime-local" id="modal-date-input" class="w-full bg-transparent font-sans font-bold text-xl text-fun-dark outline-none" aria-label="Date and Time">
            </div>
            <button onclick="confirmDate()" class="w-full bg-fun-green border-[3px] border-fun-dark rounded-xl py-3 font-pop text-xl uppercase shadow-hard active:translate-y-1 active:shadow-none transition-all">
                Confirm
            </button>
        </div>
    </dialog>

    <main class="relative w-full h-full overflow-hidden">
        
        <!-- STEP 1: INTRO -->
        <section id="step-1" class="screen active flex flex-col justify-between items-center h-full w-full z-20 pt-12 pb-0 relative" aria-label="Welcome Screen">
            
            <!-- Top Section: Big Text -->
            <header class="text-center relative animate-float mt-8">
                <h1 class="font-display text-6xl md:text-7xl leading-[0.9] text-white drop-shadow-[5px_5px_0px_rgba(45,52,54,1)] tracking-tighter mb-4 flex flex-col items-center">
                    <span class="transform -rotate-6 transition hover:rotate-0 duration-300">TOO</span>
                    <span class="transform rotate-3 transition hover:rotate-0 duration-300 text-fun-yellow">LAZY</span>
                    <span class="transform -rotate-2 transition hover:rotate-0 duration-300">TO</span>
                    <span class="transform rotate-6 transition hover:rotate-0 duration-300">PICK?</span>
                </h1>
                <div class="inline-block bg-fun-dark text-fun-cream px-4 py-2 rounded-full transform -rotate-2 mt-4 shadow-hard-white">
                    <p class="font-bold tracking-widest uppercase text-sm">We choose, you eat.</p>
                </div>
            </header>
            
            <!-- Spacer -->
            <div class="flex-1"></div>

            <!-- ACTION SHEET TEASER (STICKY BOTTOM) -->
            <div class="w-full relative z-40 flex flex-col items-center justify-end">
                
                <!-- Big Action Button (Floating above sheet) -->
                <div class="relative z-50 mb-[-30px]">
                     <!-- Pulse -->
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-fun-cream/30 rounded-full animate-pulse-mega pointer-events-none" aria-hidden="true"></div>
                    
                    <button onclick="startSearch()" class="group relative w-40 h-40 bg-fun-cream rounded-full border-[6px] border-fun-dark shadow-hard transition-all duration-200 active:scale-95 active:translate-y-1 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-white">
                        <span class="font-pop text-4xl uppercase tracking-wider text-fun-dark leading-none">feed<br>me</span>
                    </button>
                </div>

                <!-- The Sheet Teaser -->
                <div class="w-full px-4 pb-0">
                    <button onclick="openSettings()" class="w-full bg-fun-yellow border-[4px] border-b-0 border-fun-dark rounded-t-[3rem] p-5 pb-12 shadow-sheet flex flex-col items-center justify-center gap-3 transition-all hover:bg-[#FDE047] hover:translate-y-[-6px] active:translate-y-0 cursor-pointer group relative z-40 animate-peek">
                        <!-- Handle (Subtler) -->
                        <div class="w-16 h-1.5 bg-fun-dark/20 rounded-full mb-0.5 transition-colors group-hover:bg-fun-dark/40"></div>
                        
                        <!-- Content Layout -->
                        <div class="flex items-center justify-center gap-3 font-pop text-fun-dark text-lg tracking-wide w-full">
                            <span id="config-summary-text" class="truncate">Near You â€¢ Walkable â€¢ Now</span>
                            
                            <!-- Animated Chevron in Circle -->
                            <div class="bg-fun-dark/10 p-1.5 rounded-full group-hover:bg-fun-dark/20 transition-colors">
                                <i data-lucide="chevron-up" class="w-4 h-4 stroke-[3px] group-hover:-translate-y-0.5 transition-transform"></i>
                            </div>
                        </div>
                    </button>
                </div>

            </div>
        </section>

        <!-- STEP 3: LOADER -->
        <section id="step-3" class="screen-transition absolute inset-0 flex flex-col items-center justify-center p-6 z-40 translate-y-full pointer-events-none" aria-label="Loading Results" aria-live="polite">
            <div class="absolute w-[140vw] h-[140vw] bg-fun-cream/10 rounded-full animate-ping opacity-20 pointer-events-none" style="animation-duration: 3s" aria-hidden="true"></div>
            <div class="relative mb-12">
                 <div class="loader-shape">
                    <div class="orbit-dot"></div>
                 </div>
            </div>
            <div class="text-center relative z-10 px-6">
                <h3 id="loading-title" class="font-pop text-3xl md:text-4xl text-fun-cream drop-shadow-[4px_4px_0px_#2C2A32] uppercase tracking-wide animate-pulse text-center leading-tight">Consulting the Food Gods...</h3>
            </div>
        </section>

        <!-- STEP 4: RESULT -->
        <section id="step-4" class="screen-transition absolute inset-0 flex flex-col p-6 z-50 translate-y-full pointer-events-none" aria-label="Restaurant Result">
            <div class="flex-1 flex flex-col w-full max-w-md mx-auto pt-8 pb-8 overflow-y-auto no-scrollbar">
                <header class="text-center mb-6 animate-float">
                    <h2 class="font-pop text-4xl text-white drop-shadow-[3px_3px_0px_rgba(45,52,54,1)] uppercase transform -rotate-2">It's a Match!</h2>
                </header>

                <article class="bg-white border-[5px] border-fun-dark rounded-3xl shadow-hard overflow-hidden flex-1 flex flex-col mb-6 transform rotate-1 hover:rotate-0 transition-transform duration-300 relative group min-h-[300px]">
                    <figure class="h-48 bg-gray-200 relative border-b-[5px] border-fun-dark overflow-hidden m-0">
                         <img id="res-img" src="" class="w-full h-full object-cover animate-photo" alt="Food at restaurant">
                         <div class="absolute top-3 right-3 bg-fun-yellow border-[3px] border-fun-dark px-3 py-1 rounded-xl font-bold text-fun-dark shadow-hard-hover text-sm z-10">
                            <span id="res-price">$$$</span>
                         </div>
                         <button onclick="shareResult()" class="absolute top-3 left-3 bg-white/95 backdrop-blur-md border-[3px] border-fun-dark p-3 rounded-xl shadow-hard-hover text-fun-dark active:scale-95 transition-transform z-20" title="Share" aria-label="Share Restaurant">
                            <i data-lucide="share-2" class="w-6 h-6 stroke-[2.5px]"></i>
                         </button>
                    </figure>
                    
                    <div class="p-6 flex-1 flex flex-col relative">
                        <div class="absolute -top-5 left-6 bg-fun-green border-[3px] border-fun-dark px-3 py-1 rounded-full font-bold text-white shadow-hard-hover flex items-center gap-1 transform -rotate-3 z-20">
                            <i data-lucide="star" class="w-4 h-4 fill-white"></i>
                            <span id="res-rating">4.8</span>
                        </div>

                        <h3 id="res-name" class="font-pop text-3xl text-fun-dark leading-tight mb-2 mt-2">Taco Loco</h3>
                        <p id="res-desc" class="font-sans font-medium text-fun-dark/70 text-lg leading-snug mb-4 line-clamp-3">Authentic street tacos served from a truck that looks like a spaceship.</p>
                        
                        <div class="mt-auto space-y-3">
                            <address class="flex flex-col gap-2 text-fun-dark font-bold font-sans text-sm not-italic">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="map-pin" class="w-5 h-5 text-fun-red shrink-0"></i>
                                    <span id="res-addr">55 Space Blvd</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i data-lucide="phone" class="w-5 h-5 text-fun-blue shrink-0"></i>
                                    <a id="res-phone" href="#" class="hover:underline decoration-2 decoration-fun-blue">555-0199</a>
                                </div>
                            </address>

                            <div class="flex gap-2 flex-wrap pt-2" id="res-tags"></div>
                        </div>
                    </div>
                </article>

                <div class="flex gap-3">
                    <button onclick="triggerHaptic(10); retrySearch()" class="w-20 bg-fun-yellow border-[4px] border-fun-dark rounded-2xl flex items-center justify-center shadow-hard transition-transform active:translate-y-1 active:shadow-none hover:brightness-110" title="Spin Again" aria-label="Reroll">
                        <i data-lucide="refresh-cw" class="w-8 h-8 stroke-[3px] text-fun-dark"></i>
                    </button>

                    <button onclick="triggerHaptic(20); alert('Opening Maps...')" class="flex-1 bg-fun-green border-[4px] border-fun-dark rounded-2xl py-4 shadow-hard flex items-center justify-center gap-2 transition-transform active:translate-y-1 active:shadow-none hover:brightness-110">
                        <span class="font-pop text-2xl text-fun-dark uppercase tracking-wide">Let's Eat!</span>
                        <i data-lucide="navigation" class="w-6 h-6 stroke-[3px] text-fun-dark"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- STEP 5: NO RESULTS -->
        <section id="step-5" class="screen-transition absolute inset-0 flex flex-col items-center justify-center text-center gap-6 p-6 z-50 translate-y-full pointer-events-none" aria-label="No Results Found">
            <div><h2 class="font-pop text-4xl text-white drop-shadow-[3px_3px_0px_#2C2A32]">Ghost Town?</h2></div>
            <button onclick="goToStep(1); openSettings()" class="bg-fun-yellow border-[4px] border-fun-dark px-8 py-4 rounded-2xl font-pop text-xl text-fun-dark shadow-hard hover:scale-105">Adjust Filters</button>
        </section>

        <section id="step-6" class="screen-transition absolute inset-0 flex flex-col items-center justify-center text-center gap-6 p-6 z-50 translate-y-full pointer-events-none" aria-label="Service Unavailable">
            <div><h2 class="font-pop text-4xl text-white drop-shadow-[3px_3px_0px_#2C2A32]">System Overload!</h2></div>
            <button onclick="location.reload()" class="bg-fun-cream border-[4px] border-fun-dark px-8 py-4 rounded-2xl font-pop text-xl text-fun-dark shadow-hard hover:scale-105">Try Later</button>
        </section>

    </main>

    <script>
        const iconColor = "#2C2A32"; 
        const createSvgDataUri = (svg) => `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        const pizzaSvgRaw = `<svg viewBox="0 0 512 512" fill="${iconColor}" xmlns="http://www.w3.org/2000/svg"><path d="M464 64L32 256l224 224L464 64zm-243 234a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm96-64a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm-64-96a32 32 0 1 1 0-64 32 32 0 1 1 0 64z"/></svg>`;
        const pizzaSvg = createSvgDataUri(pizzaSvgRaw);

        function triggerHaptic(pattern) { if (navigator.vibrate) navigator.vibrate(pattern); }

        function goToStep(step) {
            document.querySelectorAll('section[id^="step-"]').forEach(el => {
                el.classList.remove('active', 'translate-y-0', 'pointer-events-auto');
                el.classList.add('translate-y-full', 'pointer-events-none'); 
                if (el.id !== `step-${step}`) el.classList.add('prev');
            });

            const target = document.getElementById(`step-${step}`);
            target.classList.remove('translate-y-full', 'pointer-events-none', 'prev');
            target.classList.add('active', 'translate-y-0', 'pointer-events-auto');
            
            const rain = document.getElementById('rain-container');
            rain.style.opacity = step === 1 ? '1' : '0';

            setTimeout(() => lucide.createIcons(), 100);
        }

        // --- SETTINGS MODAL LOGIC ---
        function openSettings() {
            triggerHaptic(10);
            const modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.showModal();
        }

        function closeSettings() {
            triggerHaptic(10);
            const modal = document.getElementById('settings-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modal.close();
            updateConfigSummary(); 
        }
        
        function updateConfigSummary() {
            const loc = document.getElementById('loc-input').value || "Near You";
            const dist = document.getElementById('distance-text').innerText;
            
            const radios = document.getElementsByName('time');
            let timeVal = 'Now';
            for(let r of radios) { 
                if(r.checked) {
                    if(r.value === 'now') timeVal = 'Now';
                    else if(r.value === 'tonight') timeVal = 'Tonight';
                    else if(r.value === 'custom') timeVal = 'Later';
                    else timeVal = 'Tomorrow';
                }
            }
            
            const summary = `${loc === "Near You" ? "ðŸ“" : ""} ${loc} â€¢ ${dist} â€¢ ${timeVal}`;
            document.getElementById('config-summary-text').innerText = summary;
        }

        function detectLocation() {
            const input = document.getElementById('loc-input');
            if (!input.value && "geolocation" in navigator) {
                input.placeholder = "Locating...";
                navigator.geolocation.getCurrentPosition(pos => {
                    input.value = `Near you`;
                }, err => {
                    input.value = ""; input.placeholder = "City...";
                });
            }
        }

        const input = document.getElementById('loc-input');
        const list = document.getElementById('autocomplete-list');
        const suggestions = ["Downtown", "Times Square", "Brooklyn", "Central Park", "SoHo", "Chinatown"];

        input.addEventListener('input', function() {
            const val = this.value;
            list.innerHTML = '';
            if (!val) { list.classList.add('hidden'); return; }
            
            const matches = suggestions.filter(i => i.toLowerCase().includes(val.toLowerCase()));
            if (matches.length > 0) {
                list.classList.remove('hidden');
                matches.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'suggestion-item';
                    li.innerHTML = `<i data-lucide="map-pin" class="w-4 h-4 text-gray-400"></i> ${item}`;
                    li.addEventListener('click', () => {
                        input.value = item;
                        list.classList.add('hidden');
                        triggerHaptic(10);
                    });
                    list.appendChild(li);
                });
                lucide.createIcons();
            } else {
                list.classList.add('hidden');
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target !== input) list.classList.add('hidden');
        });

        function openDatePicker() {
            triggerHaptic(10);
            const modal = document.getElementById('date-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.showModal();
        }

        function closeDatePicker() {
            triggerHaptic(10);
            const modal = document.getElementById('date-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modal.close();
        }

        function confirmDate() {
            triggerHaptic(10);
            const val = document.getElementById('modal-date-input').value;
            console.log("Date selected:", val);
            closeDatePicker();
        }

        function updateDistanceLabel(val) {
            const labelText = document.getElementById('distance-text');
            const labels = ["Close", "Short Drive", "Adventure"];
            labelText.innerText = labels[val - 1];
        }

        function initDragScroll() {
            const slider = document.getElementById('time-scroll-container');
            let isDown = false;
            let startX;
            let scrollLeft;
            let isDragging = false;

            slider.addEventListener('mousedown', (e) => {
                isDown = true; isDragging = false;
                slider.classList.add('cursor-grabbing');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('cursor-grabbing'); });
            slider.addEventListener('mouseup', () => { 
                isDown = false; slider.classList.remove('cursor-grabbing'); 
                setTimeout(() => isDragging = false, 50);
            });
            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2;
                if(Math.abs(walk) > 5) isDragging = true;
                slider.scrollLeft = scrollLeft - walk;
            });
            
            slider.querySelectorAll('.slider-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    if(isDragging) { e.preventDefault(); return false; }
                    if(opt.querySelector('input').value === 'custom') openDatePicker();
                    triggerHaptic(10);
                });
            });

            slider.addEventListener('wheel', (e) => {
                e.preventDefault();
                slider.scrollLeft += e.deltaY;
            });
        }

        function startSearch() {
            goToStep(3);
            triggerHaptic([50, 50, 50]);

            const msgs = ["Consulting stars...", "Scanning hunger...", "Avoiding kale...", "Calibrating...", "Rolling flavor..."];
            const el = document.getElementById('loading-title');
            let idx = 0;
            
            const interval = setInterval(() => {
                el.innerText = msgs[idx];
                idx = (idx + 1) % msgs.length;
                triggerHaptic(5);
            }, 800);

            setTimeout(() => {
                clearInterval(interval);
                const r = Math.random();
                if(r > 0.9) { showQuotaError(); } 
                else if(r > 0.8) { showNoResults(); }
                else { showResult(); }
            }, 4000);
        }
        
        function showNoResults() { goToStep(5); triggerHaptic([200, 100]); }
        function showQuotaError() { goToStep(6); triggerHaptic([500]); }

        function showResult() {
            const places = [
                { name: "Taco Loco", img: "https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=600&q=80", price: "$", rating: "4.9", desc: "Authentic street tacos.", addr: "55 Space Blvd", tags: ["Mexican", "Tacos"], bookable: false, phone: "555-0101" },
                { name: "Burger King (JK)", img: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=600&q=80", price: "$$", rating: "4.5", desc: "Royalty worthy burgers.", addr: "1 Castle Rd", tags: ["Burgers", "American"], bookable: true, phone: "555-0202" },
            ];
            const choice = places[Math.floor(Math.random() * places.length)];
            
            document.getElementById('res-name').innerText = choice.name;
            document.getElementById('res-img').src = choice.img;
            document.getElementById('res-price').innerText = choice.price;
            document.getElementById('res-rating').innerText = choice.rating;
            document.getElementById('res-desc').innerText = choice.desc;
            document.getElementById('res-addr').innerText = choice.addr;
            
            const phoneEl = document.getElementById('res-phone');
            phoneEl.innerText = choice.phone;
            phoneEl.href = `tel:${choice.phone}`;
            
            const container = document.getElementById('res-tags');
            container.innerHTML = '';
            
            if(choice.bookable) {
                const btn = document.createElement('span');
                btn.className = "px-2 py-1 bg-fun-blue text-white border-2 border-fun-dark rounded-lg text-xs font-bold flex items-center gap-1";
                btn.innerHTML = `<i data-lucide="calendar-check" class="w-3 h-3"></i> Book Online`;
                container.appendChild(btn);
            }
            choice.tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = "px-2 py-1 bg-fun-cream border-2 border-fun-dark rounded-lg text-xs font-bold";
                span.innerText = tag;
                container.appendChild(span);
            });
            
            lucide.createIcons();
            triggerHaptic([50, 50, 50]);
            goToStep(4);
        }

        async function shareResult() {
            triggerHaptic(10);
            const name = document.getElementById('res-name').innerText;
            const addr = document.getElementById('res-addr').innerText;
            const text = `Let's eat at ${name}! ðŸ• It's at ${addr}. Found via BiteRoulette.`;
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Dinner Plan?',
                        text: text,
                        url: window.location.href
                    });
                } catch (err) {
                    console.log('Share canceled');
                }
            } else {
                alert('Copied to clipboard: ' + text);
            }
        }

        function retrySearch() { startSearch(); }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initDragScroll();
            
            if(window.tsParticles) {
                tsParticles.load("rain-container", {
                    particles: {
                        number: { value: 8 },
                        shape: { type: "image", image: [{ src: pizzaSvg, width: 100, height: 100 }] },
                        opacity: { value: 0.12, random: false },
                        size: { value: { min: 40, max: 80 }, random: true },
                        move: { enable: true, speed: 3, direction: "bottom" },
                        rotate: { value: 0, random: true, direction: "clockwise", animation: { enable: true, speed: 5 } }
                    },
                    interactivity: { detectsOn: "canvas", events: { resize: true } },
                    detectRetina: true
                });
            }
        });
    </script>
</body>
</html>