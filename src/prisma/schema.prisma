generator client {
  provider   = "prisma-client"
  output     = "../app/features/generated/prisma.server"
  runtime    = "cloudflare"

}

datasource db {
  provider = "postgresql"
}

enum ServiceTimeslot {
  Dinner
  Lunch
  RightNow
  Custom

  @@map("service_timeslot")
}

enum DistanceRange {
  Close
  MidRange
  Far

  @@map("distance_range")
}

model Search {
  id              String @id @default(uuid()) @db.Uuid
  latitude        Float
  longitude       Float
  distanceRange   DistanceRange
  createdAt       DateTime @default(now())
  exhausted       Boolean @default(false)

  serviceDate     DateTime @db.Date
  serviceTimeslot ServiceTimeslot
  serviceInstant  DateTime
  serviceEnd      DateTime

  candidates      SearchCandidate[]

  @@map("search")
}

enum SearchCandidateStatus {
  Rejected
  Returned

  @@map("search_candidate_status")
}

model SearchCandidate {
  id              String @id @default(uuid()) @db.Uuid
  createdAt       DateTime @default(now())
  order           Int

  searchId        String @db.Uuid
  search          Search @relation(fields: [searchId], references: [id])

  restaurantId    String? @db.Uuid
  restaurant      Restaurant? @relation(fields: [restaurantId], references: [id])

  status          SearchCandidateStatus

  rejectionReason String? @db.VarChar(200)

  @@index([searchId])
  @@index([searchId, status])
  @@index([restaurantId, status])

  @@map("search_candidate")
}


model Restaurant {
  id                       String @id @default(uuid()) @db.Uuid
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  name                     String? @db.VarChar(100)
  latitude                 Decimal
  longitude                Decimal

  profiles                 RestaurantProfile[]
  searchCandidates         SearchCandidate[]
  matchingAttempts         RestaurantMatchingAttempt[]

  @@map("restaurant")
}

model RestaurantProfile {
  id                       String @id @default(uuid()) @db.Uuid
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  restaurantId             String @db.Uuid
  restaurant               Restaurant @relation(fields: [restaurantId], references: [id])

  source                   String @db.VarChar(50)
  externalId               String @db.VarChar(255)
  externalType             String @db.VarChar(50)
  version                  Int

  // attributes from the source
  latitude                 Decimal
  longitude                Decimal
  name                     String?
  address                  String?
  countryCode              String? @db.VarChar(20)
  state                    String? @db.VarChar(50)
  description              String?
  imageUrl                 String?
  mapUrl                   String?
  rating                   Decimal? @db.Decimal(2, 1)
  ratingCount              Int?
  phoneNumber              String? @db.VarChar(20)
  internationalPhoneNumber String? @db.VarChar(25)
  priceRange               Int?
  priceLabel               String?
  openingHours             String?
  tags                     String[] @db.VarChar(30)
  operational              Boolean?
  website                  String?
  sourceUrl                String?

  @@index([source, externalId, restaurantId])
  @@index([source, externalId])
  @@map("restaurant_profile")
}

model RestaurantMatchingAttempt {
  id           String @id @default(uuid()) @db.Uuid

  restaurantId String @db.Uuid
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  queryType    String
  latitude     Decimal?
  longitude    Decimal?
  radius       Int?
  query        String?

  source       String @db.VarChar(50)
  found        Boolean

  attemptedAt  DateTime @default(now())

  @@index(source)
  @@map("restaurant_matching_attempt")
}
