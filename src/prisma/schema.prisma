generator client {
  provider = "prisma-client"
  output   = "../app/features/generated/prisma.server"
}

datasource db {
  provider = "postgresql"
}

enum ServiceTimeslot {
  Dinner
  Lunch
  RightNow
  Custom

   @@map("service_timeslot")
}

enum DistanceRange {
  Close
  MidRange
  Far

  @@map("distance_range")
}

enum RestaurantIdentityLookupStatus {
  FOUND
  NOT_FOUND

  @@map("restaurant_identity_lookup_status")
}

model Search {
  id              String @id @default(uuid()) @db.Uuid
  latitude        Float
  longitude       Float
  distanceRange   DistanceRange
  createdAt       DateTime @default(now())
  exhausted       Boolean @default(false)

  serviceDate     DateTime @db.Date
  serviceTimeslot ServiceTimeslot
  serviceInstant  DateTime
  serviceEnd      DateTime

  candidates      SearchCandidate[]

   @@map("search")
}

enum SearchCandidateStatus {
  Rejected
  Returned

  @@map("search_candidate_status")
}

model SearchCandidate {
  id              String @id @default(uuid()) @db.Uuid
  createdAt       DateTime @default(now())
  order           Int

  searchId        String @db.Uuid
  search          Search @relation(fields: [searchId], references: [id])

  restaurantId    String @db.Uuid
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id])

  status          SearchCandidateStatus

  rejectionReason String? @db.VarChar(50)

  @@index([searchId, status])

  @@map("search_candidate")
}

model Restaurant {
  id               String @id @default(uuid()) @db.Uuid
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  version          Int @default(1)

  identities       RestaurantIdentity[]
  searchCandidates SearchCandidate[]

  matched          Boolean @default(false)
  matchingAttempts RestaurantMatchingAttempt[]

  name             String @db.VarChar(100)
  latitude         Float
  longitude        Float
  address          String?
  countryCode      String? @db.VarChar(20)
  state            String? @db.VarChar(50)

  description      String?
  imageUrl         String?
  rating           Decimal? @db.Decimal(2, 1)
  phoneNumber      String? @db.VarChar(20)
  priceRange       Int?
  openingHours     String?
  tags             String[] @db.VarChar(30)

  @@map("restaurant")
}

model RestaurantIdentity {
  id           String @id @default(uuid()) @db.Uuid

  restaurantId String @db.Uuid
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  source       String @db.VarChar(50)
  externalId   String @db.VarChar(255)
  type         String @db.VarChar(50)

  @@unique([source, externalId])
  @@map("restaurant_identity")
}

// TODO add a "matching score" to assess ourselves if the restaurant matches properly
model RestaurantMatchingAttempt {
  id           String   @id @default(uuid()) @db.Uuid

  restaurantId String @db.Uuid
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  queryType    String
  latitude     Decimal?
  longitude    Decimal?
  radius       Int?
  query        String?

  source       String @db.VarChar(50)
  status       RestaurantIdentityLookupStatus

  attemptedAt  DateTime @default(now())

  @@index(source)
  @@map("restaurant_matching_attempt")
}
