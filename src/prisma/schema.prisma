generator client {
  provider = "prisma-client"
  output   = "../app/features/generated/prisma.server"
}

datasource db {
  provider = "postgresql"
}

enum ServiceTimeslot {
  Dinner
  Lunch
  RightNow
  Custom
}

enum DistanceRange {
  Close
  MidRange
  Far
}

model Search {
  id              String @id @default(uuid()) @db.Uuid
  latitude        Float
  longitude       Float
  distanceRange   DistanceRange
  createdAt       DateTime @default(now())
  exhausted       Boolean @default(false)

  serviceDate     DateTime @db.Date
  serviceTimeslot ServiceTimeslot
  serviceInstant  DateTime
  serviceEnd      DateTime

  candidates      SearchCandidate[]
}

enum SearchCandidateStatus {
  Rejected
  Returned
  Pending
}

model SearchCandidate {
  id              String @id @default(uuid()) @db.Uuid
  createdAt       DateTime @default(now())
  order           Int

  searchId        String @db.Uuid
  search          Search @relation(fields: [searchId], references: [id])

  restaurantId    String @db.Uuid
  restaurant      Restaurant @relation(fields: [restaurantId], references: [id])

  status          SearchCandidateStatus @default(Pending)

  rejectionReason String? @db.VarChar(50)

  @@index([searchId, status])
}

model Restaurant {
  id               String @id @default(uuid()) @db.Uuid
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  version          Int @default(1)

  identities       RestaurantIdentity[]
  searchCandidates SearchCandidate[]

  name             String @db.VarChar(100)
  latitude         Float
  longitude        Float
  address          String?
  countryCode      String? @db.VarChar(20)
  state            String? @db.VarChar(50)

  description      String?
  imageUrl         String?
  rating           Decimal? @db.Decimal(2, 1)
  phoneNumber      String? @db.VarChar(20)
  priceRange       Int?
  openingHours     String?
  tags             String[] @db.VarChar(30)
}

model RestaurantIdentity {
  id           String @id @default(uuid()) @db.Uuid

  restaurantId String @db.Uuid
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  source       String @db.VarChar(50)
  externalId   String @db.VarChar(255)
  type         String @db.VarChar(50)

  @@unique([source, externalId])
}
